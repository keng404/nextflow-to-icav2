# nextflow-to-icav2
R-based helper scripts to generate XML files and modifications to NF scripts for ICAv2 compatiblity.
This is meant to be a developer tool to help them develop Nextflow pipelines that will run successfully on ICA

What these scripts do is parse configuration files and the main NF script of a pipeline and update the underlying processes with what's mentioned below.
Additionally parameters mentioned in these configuration files that are not referenced in the main NF file are brought into the main NF script. As ICA does not
allow you to use your own configuration files currently

Nextflow workflows on ICA are orchestrated by kubernetes and require a parameters XML file 
- containing data inputs (i.e. files + folders) and other string-based options for all configurable parameters to properly be passed from ICA to your Nextflow workflows
- processes will need to contain a reference to a container --- a Docker image that will run that specific process
- processes will need a  ```pod annotation``` specified for ICA to know what instance type to run the process.
  - A table of instance types and the associated CPU + Memory specs can be found [here](https://illumina.gitbook.io/ica/project/p-flow/f-pipelines#compute-types)  

These scripts have been made to be compatible with [nf-core](https://github.com/nf-core) workflows

The scripts mentioned below can be run in a docker image ```keng404/nfcore-to-ica:0.0.2```

**DSL2 compatibility is now implemented but needs to be tested (i.e. successful pipeline runs)**

# To generate an XML file from nf-core pipeline
```bash
Rscript nf-core.json_to_params_xml.R --json {PATH_TO_SCHEMA_JSON}
```
- A Nextflow schema JSON is generated by nf-core's python library nf-core
- nf-core can be installed via a ```pip install nf-core``` command
```bash
nf-core schema build -d {PATH_NF-CORE_DIR}
```

# To generate an XML file and edits to Nextflow script, use the following template
```bash
Rscript  nf-core.ica_mod_nf_script.R --nf-script {MAIN_NF_SCRIPT} --nf-config {DEFAULT_NF_CONFIG}  [OPTIONAL: --parameters-xml {PATH} or --generate-parameters-xml]
```
Specifying the ```--parameters-xml``` parameter tells the ```nf-core.ica_mod_nf_script.R``` to generate an XML files based on the NF script and config you specify.
Default behavior is to traverse the config file you provide and parse additional config files that might be referenced. Not setting the ```--parameters-xml``` flag will tell the script to just focus on making edits to NF script.

A current list of todos for this script is [here](https://github.com/keng404/nextflow-to-icav2/blob/master/todos.nf_editing_for_icav2.md)

# To create a pipeline in ICA, you can use the following helper script ```nf-core.create_ica_pipeline.R```
```bash
Rscript nf-core.create_ica_pipeline.R --nextflow-script {NF_SCRIPT} --workflow-language nextflow --parameters-xml {PARAMETERS_XML} --nf-core-mode --ica-project-name {NAME} --pipeline-name {NAME} --api-key-file {PATH_TO_API_KEY_FILE}
```

By default, this script will automatically try to upload all files found in the same directory as your {NF_SCRIPT}, excluding any nextflow config files (i.e. *config)

